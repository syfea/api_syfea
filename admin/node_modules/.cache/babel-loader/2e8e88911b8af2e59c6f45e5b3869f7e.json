{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _getIterator2 = require(\"babel-runtime/core-js/get-iterator\");\n\nvar _getIterator3 = _interopRequireDefault(_getIterator2);\n\nexports.getDocumentationUrlFromHeaders = getDocumentationUrlFromHeaders;\nexports.default = parseHydraDocumentation;\n\nvar _jsonld = require(\"jsonld\");\n\nvar _lodash = require(\"lodash.get\");\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nvar _Api = require(\"../Api\");\n\nvar _Api2 = _interopRequireDefault(_Api);\n\nvar _Field = require(\"../Field\");\n\nvar _Field2 = _interopRequireDefault(_Field);\n\nvar _Resource = require(\"../Resource\");\n\nvar _Resource2 = _interopRequireDefault(_Resource);\n\nvar _Operation = require(\"../Operation\");\n\nvar _Operation2 = _interopRequireDefault(_Operation);\n\nvar _fetchJsonLd = require(\"./fetchJsonLd\");\n\nvar _fetchJsonLd2 = _interopRequireDefault(_fetchJsonLd);\n\nvar _addParameters = require(\"./addParameters\");\n\nvar _addParameters2 = _interopRequireDefault(_addParameters);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n/**\n * Extracts the short name of a resource.\n *\n * @param {string} url\n * @param {string} entrypointUrl\n * @return {string}\n */\n\n\nfunction guessNameFromUrl(url, entrypointUrl) {\n  return url.substr(entrypointUrl.length + 1);\n}\n/**\n * Finds the description of the class with the given id.\n *\n * @param {object[]} docs\n * @param {string} classToFind\n * @return {object}\n */\n\n\nfunction findSupportedClass(docs, classToFind) {\n  var supportedClasses = (0, _lodash2.default)(docs, '[0][\"http://www.w3.org/ns/hydra/core#supportedClass\"]');\n\n  if (!Array.isArray(supportedClasses)) {\n    throw new Error('The API documentation has no \"http://www.w3.org/ns/hydra/core#supportedClass\" key or its value is not an array.');\n  }\n\n  var _iteratorNormalCompletion = true;\n  var _didIteratorError = false;\n  var _iteratorError = undefined;\n\n  try {\n    for (var _iterator = (0, _getIterator3.default)(supportedClasses), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n      var supportedClass = _step.value;\n\n      if (supportedClass[\"@id\"] === classToFind) {\n        return supportedClass;\n      }\n    }\n  } catch (err) {\n    _didIteratorError = true;\n    _iteratorError = err;\n  } finally {\n    try {\n      if (!_iteratorNormalCompletion && _iterator.return) {\n        _iterator.return();\n      }\n    } finally {\n      if (_didIteratorError) {\n        throw _iteratorError;\n      }\n    }\n  }\n\n  throw new Error(\"The class \\\"\" + classToFind + \"\\\" is not defined in the API documentation.\");\n}\n\nfunction getDocumentationUrlFromHeaders(headers) {\n  var linkHeader = headers.get(\"Link\");\n\n  if (!linkHeader) {\n    throw new Error('The response has no \"Link\" HTTP header.');\n  }\n\n  var matches = linkHeader.match(/<(.+)>; rel=\"http:\\/\\/www.w3.org\\/ns\\/hydra\\/core#apiDocumentation\"/);\n\n  if (!matches[1]) {\n    throw new Error('The \"Link\" HTTP header is not of the type \"http://www.w3.org/ns/hydra/core#apiDocumentation\".');\n  }\n\n  return matches[1];\n}\n/**\n * Retrieves Hydra's entrypoint and API docs.\n *\n * @param {string} entrypointUrl\n * @param {object} options\n * @return {Promise}\n */\n\n\nfunction fetchEntrypointAndDocs(entrypointUrl) {\n  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  return (0, _fetchJsonLd2.default)(entrypointUrl, options).then(function (d) {\n    var docsUrl = getDocumentationUrlFromHeaders(d.response.headers);\n    return {\n      entrypointUrl: entrypointUrl,\n      docsUrl: docsUrl,\n      entrypoint: d.body,\n      response: d.response\n    };\n  }).then(function (data) {\n    return (0, _fetchJsonLd2.default)(data.docsUrl, options).then(function (d) {\n      data.docs = d.body;\n      return data;\n    }).then(function (data) {\n      return _jsonld.promises.expand(data.docs, {\n        base: data.docsUrl,\n        documentLoader: function documentLoader(input) {\n          return (0, _fetchJsonLd2.default)(input, options);\n        }\n      }).then(function (docs) {\n        data.docs = docs;\n        return data;\n      });\n    }).then(function (data) {\n      return _jsonld.promises.expand(data.entrypoint, {\n        base: data.entrypointUrl,\n        documentLoader: function documentLoader(input) {\n          return (0, _fetchJsonLd2.default)(input, options);\n        }\n      }).then(function (entrypoint) {\n        data.entrypoint = entrypoint;\n        return data;\n      });\n    });\n  });\n}\n\nfunction removeTrailingSlash(url) {\n  if (/\\/$/.test(url)) {\n    url = url.slice(0, -1);\n  }\n\n  return url;\n}\n/**\n *\n * @param {object} docs\n * @param {object} property\n * @return {string|null}\n */\n\n\nfunction findRelatedClass(docs, property) {\n  // Use the entrypoint property's owl:equivalentClass if available\n  if (Array.isArray(property[\"http://www.w3.org/2000/01/rdf-schema#range\"])) {\n    var _iteratorNormalCompletion2 = true;\n    var _didIteratorError2 = false;\n    var _iteratorError2 = undefined;\n\n    try {\n      for (var _iterator2 = (0, _getIterator3.default)(property[\"http://www.w3.org/2000/01/rdf-schema#range\"]), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {\n        var range = _step2.value;\n        var onProperty = (0, _lodash2.default)(range, '[\"http://www.w3.org/2002/07/owl#equivalentClass\"][0][\"http://www.w3.org/2002/07/owl#onProperty\"][0][\"@id\"]');\n        var allValuesFrom = (0, _lodash2.default)(range, '[\"http://www.w3.org/2002/07/owl#equivalentClass\"][0][\"http://www.w3.org/2002/07/owl#allValuesFrom\"][0][\"@id\"]');\n\n        if (allValuesFrom && \"http://www.w3.org/ns/hydra/core#member\" === onProperty) {\n          return findSupportedClass(docs, allValuesFrom);\n        }\n      }\n    } catch (err) {\n      _didIteratorError2 = true;\n      _iteratorError2 = err;\n    } finally {\n      try {\n        if (!_iteratorNormalCompletion2 && _iterator2.return) {\n          _iterator2.return();\n        }\n      } finally {\n        if (_didIteratorError2) {\n          throw _iteratorError2;\n        }\n      }\n    }\n  } // As a fallback, find an operation available on the property of the entrypoint returning the searched type (usually POST)\n\n\n  var _iteratorNormalCompletion3 = true;\n  var _didIteratorError3 = false;\n  var _iteratorError3 = undefined;\n\n  try {\n    for (var _iterator3 = (0, _getIterator3.default)(property[\"http://www.w3.org/ns/hydra/core#supportedOperation\"]), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {\n      var entrypointSupportedOperation = _step3.value;\n\n      if (!entrypointSupportedOperation[\"http://www.w3.org/ns/hydra/core#returns\"]) {\n        continue;\n      }\n\n      var returns = (0, _lodash2.default)(entrypointSupportedOperation, '[\"http://www.w3.org/ns/hydra/core#returns\"][0][\"@id\"]');\n\n      if (\"string\" === typeof returns && 0 !== returns.indexOf(\"http://www.w3.org/ns/hydra/core\")) {\n        return findSupportedClass(docs, returns);\n      }\n    }\n  } catch (err) {\n    _didIteratorError3 = true;\n    _iteratorError3 = err;\n  } finally {\n    try {\n      if (!_iteratorNormalCompletion3 && _iterator3.return) {\n        _iterator3.return();\n      }\n    } finally {\n      if (_didIteratorError3) {\n        throw _iteratorError3;\n      }\n    }\n  }\n\n  throw new Error(\"Cannot find the class related to \" + property[\"@id\"] + \".\");\n}\n/**\n * Parses a Hydra documentation and converts it to an intermediate representation.\n *\n * @param {string} entrypointUrl\n * @param {object} options\n * @return {Promise.<Api>}\n */\n\n\nfunction parseHydraDocumentation(entrypointUrl) {\n  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  entrypointUrl = removeTrailingSlash(entrypointUrl);\n  return fetchEntrypointAndDocs(entrypointUrl, options).then(function (_ref) {\n    var entrypoint = _ref.entrypoint,\n        docs = _ref.docs,\n        response = _ref.response;\n    var resources = [],\n        fields = [],\n        operations = [];\n    var title = (0, _lodash2.default)(docs, '[0][\"http://www.w3.org/ns/hydra/core#title\"][0][\"@value\"]', \"API Platform\");\n    var entrypointType = (0, _lodash2.default)(entrypoint, '[0][\"@type\"][0]');\n\n    if (!entrypointType) {\n      throw new Error('The API entrypoint has no \"@type\" key.');\n    }\n\n    var entrypointClass = findSupportedClass(docs, entrypointType);\n\n    if (!Array.isArray(entrypointClass[\"http://www.w3.org/ns/hydra/core#supportedProperty\"])) {\n      throw new Error('The entrypoint definition has no \"http://www.w3.org/ns/hydra/core#supportedProperty\" key or it is not an array.');\n    } // Add resources\n\n\n    var _iteratorNormalCompletion4 = true;\n    var _didIteratorError4 = false;\n    var _iteratorError4 = undefined;\n\n    try {\n      for (var _iterator4 = (0, _getIterator3.default)(entrypointClass[\"http://www.w3.org/ns/hydra/core#supportedProperty\"]), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {\n        var properties = _step4.value;\n        var readableFields = [],\n            resourceFields = [],\n            writableFields = [],\n            resourceOperations = [];\n        var property = (0, _lodash2.default)(properties, '[\"http://www.w3.org/ns/hydra/core#property\"][0]');\n\n        if (!property) {\n          continue;\n        } // Add fields\n\n\n        var relatedClass = findRelatedClass(docs, property);\n        var _iteratorNormalCompletion6 = true;\n        var _didIteratorError6 = false;\n        var _iteratorError6 = undefined;\n\n        try {\n          for (var _iterator6 = (0, _getIterator3.default)(relatedClass[\"http://www.w3.org/ns/hydra/core#supportedProperty\"]), _step6; !(_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done); _iteratorNormalCompletion6 = true) {\n            var supportedProperties = _step6.value;\n            var supportedProperty = (0, _lodash2.default)(supportedProperties, '[\"http://www.w3.org/ns/hydra/core#property\"][0]');\n\n            var _range = (0, _lodash2.default)(supportedProperty, '[\"http://www.w3.org/2000/01/rdf-schema#range\"][0][\"@id\"]', null);\n\n            var field = new _Field2.default(supportedProperty[\"http://www.w3.org/2000/01/rdf-schema#label\"][0][\"@value\"], {\n              id: supportedProperty[\"@id\"],\n              range: _range,\n              reference: \"http://www.w3.org/ns/hydra/core#Link\" === (0, _lodash2.default)(property, '[\"@type\"][0]') ? _range : null,\n              // Will be updated in a subsequent pass\n              required: (0, _lodash2.default)(supportedProperties, '[\"http://www.w3.org/ns/hydra/core#required\"][0][\"@value\"]', false),\n              description: (0, _lodash2.default)(supportedProperties, '[\"http://www.w3.org/ns/hydra/core#description\"][0][\"@value\"]', \"\"),\n              maxCardinality: (0, _lodash2.default)(supportedProperty, '[\"http://www.w3.org/2002/07/owl#maxCardinality\"][0][\"@value\"]', null),\n              deprecated: (0, _lodash2.default)(supportedProperties, '[\"http://www.w3.org/2002/07/owl#deprecated\"][0][\"@value\"]', false)\n            });\n            fields.push(field);\n            resourceFields.push(field);\n\n            if ((0, _lodash2.default)(supportedProperties, '[\"http://www.w3.org/ns/hydra/core#readable\"][0][\"@value\"]')) {\n              readableFields.push(field);\n            }\n\n            if ((0, _lodash2.default)(supportedProperties, '[\"http://www.w3.org/ns/hydra/core#writable\"][0][\"@value\"]')) {\n              writableFields.push(field);\n            }\n          } // parse entrypoint's operations (a.k.a. collection operations)\n\n        } catch (err) {\n          _didIteratorError6 = true;\n          _iteratorError6 = err;\n        } finally {\n          try {\n            if (!_iteratorNormalCompletion6 && _iterator6.return) {\n              _iterator6.return();\n            }\n          } finally {\n            if (_didIteratorError6) {\n              throw _iteratorError6;\n            }\n          }\n        }\n\n        if (property[\"http://www.w3.org/ns/hydra/core#supportedOperation\"]) {\n          var _iteratorNormalCompletion7 = true;\n          var _didIteratorError7 = false;\n          var _iteratorError7 = undefined;\n\n          try {\n            for (var _iterator7 = (0, _getIterator3.default)(property[\"http://www.w3.org/ns/hydra/core#supportedOperation\"]), _step7; !(_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done); _iteratorNormalCompletion7 = true) {\n              var entrypointOperation = _step7.value;\n\n              if (!entrypointOperation[\"http://www.w3.org/ns/hydra/core#returns\"]) {\n                continue;\n              }\n\n              var range = entrypointOperation[\"http://www.w3.org/ns/hydra/core#returns\"][0][\"@id\"];\n              var operation = new _Operation2.default(entrypointOperation[\"http://www.w3.org/2000/01/rdf-schema#label\"][0][\"@value\"], {\n                method: entrypointOperation[\"http://www.w3.org/ns/hydra/core#method\"][0][\"@value\"],\n                expects: entrypointOperation[\"http://www.w3.org/ns/hydra/core#expects\"] && entrypointOperation[\"http://www.w3.org/ns/hydra/core#expects\"][0][\"@id\"],\n                returns: range,\n                types: entrypointOperation[\"@type\"],\n                deprecated: (0, _lodash2.default)(entrypointOperation, '[\"http://www.w3.org/2002/07/owl#deprecated\"][0][\"@value\"]', false)\n              });\n              resourceOperations.push(operation);\n              operations.push(operation);\n            }\n          } catch (err) {\n            _didIteratorError7 = true;\n            _iteratorError7 = err;\n          } finally {\n            try {\n              if (!_iteratorNormalCompletion7 && _iterator7.return) {\n                _iterator7.return();\n              }\n            } finally {\n              if (_didIteratorError7) {\n                throw _iteratorError7;\n              }\n            }\n          }\n        } // parse resource operations (a.k.a. item operations)\n\n\n        var _iteratorNormalCompletion8 = true;\n        var _didIteratorError8 = false;\n        var _iteratorError8 = undefined;\n\n        try {\n          for (var _iterator8 = (0, _getIterator3.default)(relatedClass[\"http://www.w3.org/ns/hydra/core#supportedOperation\"]), _step8; !(_iteratorNormalCompletion8 = (_step8 = _iterator8.next()).done); _iteratorNormalCompletion8 = true) {\n            var supportedOperation = _step8.value;\n\n            if (!supportedOperation[\"http://www.w3.org/ns/hydra/core#returns\"]) {\n              continue;\n            }\n\n            var _range2 = supportedOperation[\"http://www.w3.org/ns/hydra/core#returns\"][0][\"@id\"];\n\n            var _operation = new _Operation2.default(supportedOperation[\"http://www.w3.org/2000/01/rdf-schema#label\"][0][\"@value\"], {\n              method: supportedOperation[\"http://www.w3.org/ns/hydra/core#method\"][0][\"@value\"],\n              expects: supportedOperation[\"http://www.w3.org/ns/hydra/core#expects\"] && supportedOperation[\"http://www.w3.org/ns/hydra/core#expects\"][0][\"@id\"],\n              returns: _range2,\n              types: supportedOperation[\"@type\"],\n              deprecated: (0, _lodash2.default)(supportedOperation, '[\"http://www.w3.org/2002/07/owl#deprecated\"][0][\"@value\"]', false)\n            });\n\n            resourceOperations.push(_operation);\n            operations.push(_operation);\n          }\n        } catch (err) {\n          _didIteratorError8 = true;\n          _iteratorError8 = err;\n        } finally {\n          try {\n            if (!_iteratorNormalCompletion8 && _iterator8.return) {\n              _iterator8.return();\n            }\n          } finally {\n            if (_didIteratorError8) {\n              throw _iteratorError8;\n            }\n          }\n        }\n\n        var url = (0, _lodash2.default)(entrypoint, \"[0][\\\"\" + property[\"@id\"] + \"\\\"][0][\\\"@id\\\"]\");\n\n        if (!url) {\n          throw new Error(\"Unable to find the URL for \\\"\" + property[\"@id\"] + \"\\\".\");\n        }\n\n        resources.push(new _Resource2.default(guessNameFromUrl(url, entrypointUrl), url, {\n          id: relatedClass[\"@id\"],\n          title: (0, _lodash2.default)(relatedClass, '[\"http://www.w3.org/ns/hydra/core#title\"][0][\"@value\"]', \"\"),\n          fields: resourceFields,\n          readableFields: readableFields,\n          writableFields: writableFields,\n          operations: resourceOperations,\n          deprecated: (0, _lodash2.default)(relatedClass, '[\"http://www.w3.org/2002/07/owl#deprecated\"][0][\"@value\"]', false),\n          parameters: []\n        }));\n      } // Resolve references\n\n    } catch (err) {\n      _didIteratorError4 = true;\n      _iteratorError4 = err;\n    } finally {\n      try {\n        if (!_iteratorNormalCompletion4 && _iterator4.return) {\n          _iterator4.return();\n        }\n      } finally {\n        if (_didIteratorError4) {\n          throw _iteratorError4;\n        }\n      }\n    }\n\n    var _iteratorNormalCompletion5 = true;\n    var _didIteratorError5 = false;\n    var _iteratorError5 = undefined;\n\n    try {\n      var _loop = function _loop() {\n        var field = _step5.value;\n\n        if (null !== field.reference) {\n          field.reference = resources.find(function (resource) {\n            return resource.id === field.reference;\n          }) || null;\n        }\n      };\n\n      for (var _iterator5 = (0, _getIterator3.default)(fields), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {\n        _loop();\n      }\n    } catch (err) {\n      _didIteratorError5 = true;\n      _iteratorError5 = err;\n    } finally {\n      try {\n        if (!_iteratorNormalCompletion5 && _iterator5.return) {\n          _iterator5.return();\n        }\n      } finally {\n        if (_didIteratorError5) {\n          throw _iteratorError5;\n        }\n      }\n    }\n\n    return _promise2.default.resolve({\n      api: new _Api2.default(entrypointUrl, {\n        title: title,\n        resources: resources\n      }),\n      response: response,\n      status: response.status\n    });\n  }, function (data) {\n    return _promise2.default.reject({\n      api: new _Api2.default(entrypointUrl, {\n        resources: []\n      }),\n      error: data,\n      response: data.response,\n      status: (0, _lodash2.default)(data.response, \"status\")\n    });\n  }).then(function (_ref2) {\n    var api = _ref2.api,\n        response = _ref2.response,\n        status = _ref2.status;\n    return (0, _addParameters2.default)(api, options).then(function (api) {\n      return {\n        api: api,\n        response: response,\n        status: status\n      };\n    });\n  });\n}","map":null,"metadata":{},"sourceType":"script"}